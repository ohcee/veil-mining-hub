<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Veil Mining Difficulty</title>

<style>
:root{
  --bg:#0b0f17; --card:#0f172a; --border:#1f2a44;
  --text:#e2e8f0; --muted:#94a3b8; --accent:#38bdf8;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
.wrap{max-width:1100px;margin:auto;padding:24px}
header{border:1px solid var(--border);border-radius:16px;padding:18px;background:var(--card)}
h1{margin:0 0 6px;font-size:22px}
.sub{margin:0;color:var(--muted)}
.card{border:1px solid var(--border);border-radius:16px;background:var(--card);padding:16px;margin-top:14px;overflow:hidden}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}
select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#020617;color:var(--text);max-width:280px}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid var(--border);color:var(--muted)}
small{color:var(--muted)}
canvas{width:100% !important;height:360px !important;display:block}
pre{background:#020617;border:1px solid var(--border);border-radius:12px;padding:12px;overflow:auto;font-family:var(--mono);font-size:13px;line-height:1.4}
a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
const DATA_URL = "./data/difficulty.json";

let charts = {};

function $(id){ return document.getElementById(id); }
function parseISO(ts){ return new Date(ts); }

function filterByDays(points, days){
  if (!days) return points;
  const cutoff = Date.now() - days * 24*60*60*1000;
  return points.filter(p => parseISO(p.t).getTime() >= cutoff);
}

function toXY(points){
  return points.map(p => ({ x: parseISO(p.t), y: Number(p.d) }));
}

function makeChart(canvasId, label, xy){
  const ctx = $(canvasId);
  if (charts[canvasId]) charts[canvasId].destroy();

  charts[canvasId] = new Chart(ctx, {
    type: "line",
    data: {
      datasets: [{
        label,
        data: xy,
        pointRadius: 0,
        borderWidth: 2,
        tension: 0.15
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      parsing: false,
      interaction: { mode: "index", intersect: false },
      plugins: {
        legend: { labels: { color: "#e2e8f0" } },
        tooltip: {
          callbacks: {
            label: (c) => `${label}: ${c.parsed.y.toLocaleString()}`
          }
        }
      },
      scales: {
        x: {
          type: "time",
          time: { unit: "day" },
          ticks: { color: "#94a3b8" },
          grid: { color: "rgba(31,42,68,.6)" }
        },
        y: {
          ticks: { color: "#94a3b8" },
          grid: { color: "rgba(31,42,68,.6)" }
        }
      }
    }
  });
}

function fmtTime(ts){
  const d = new Date(ts);
  return isNaN(d.getTime()) ? ts : d.toLocaleString();
}

function last(points){
  return points && points.length ? points[points.length - 1] : null;
}

async function load(){
  const res = await fetch(DATA_URL, { cache: "no-store" });
  if (!res.ok) throw new Error(`Failed to load ${DATA_URL} (${res.status})`);
  return res.json();
}

function render(data){
  const days = Number($("range").value || 0);

  const rx = filterByDays(data.randomx || [], days);
  const pp = filterByDays(data.progpow || [], days);
  const sh = filterByDays(data.sha256d || [], days);

  $("updated").textContent = data.updated ? fmtTime(data.updated) : "unknown";
  $("source").textContent = data.source || "unknown";

  $("rxNow").textContent = last(rx)?.d?.toLocaleString?.() ?? "—";
  $("ppNow").textContent = last(pp)?.d?.toLocaleString?.() ?? "—";
  $("shNow").textContent = last(sh)?.d?.toLocaleString?.() ?? "—";

  makeChart("chart-rx", "RandomX difficulty", toXY(rx));
  makeChart("chart-pp", "ProgPoW difficulty", toXY(pp));
  makeChart("chart-sh", "SHA256d difficulty", toXY(sh));

  $("status").textContent = days ? `Showing last ${days} days.` : "Showing all data.";
}

window.addEventListener("DOMContentLoaded", async () => {
  try{
    const data = await load();
    window.__data = data;
    render(data);
    $("range").addEventListener("change", () => render(window.__data));
    $("raw").textContent = JSON.stringify(data, null, 2);
  }catch(e){
    $("status").textContent = "Failed to load difficulty data. (Does data/difficulty.json exist?)";
    $("raw").textContent = String(e);
  }
});
</script>
</head>

<body>
<div class="wrap">
  <header>
    <h1>Veil Mining Difficulty</h1>
    <p class="sub">Community charts generated from periodic samples of the Veil Explorer API.</p>
  </header>

  <div class="card">
    <div class="row">
      <div>
        <span class="badge">Last updated: <span id="updated">—</span></span>
        <span class="badge">Source: <span id="source">—</span></span>
      </div>

      <div style="min-width:220px">
        <label style="margin:0 0 6px">Time range</label>
        <select id="range">
          <option value="0">All</option>
          <option value="7">Last 7 days</option>
          <option value="30" selected>Last 30 days</option>
          <option value="90">Last 90 days</option>
          <option value="365">Last 365 days</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <small id="status">—</small>
      <small>RandomX: <b id="rxNow">—</b> • ProgPoW: <b id="ppNow">—</b> • SHA256d: <b id="shNow">—</b></small>
    </div>

    <small style="display:block;margin-top:10px">
      Data file: <a href="./data/difficulty.json" target="_blank" rel="noopener">data/difficulty.json</a>
    </small>
  </div>

  <div class="card"><div style="height:360px"><canvas id="chart-rx"></canvas></div></div>
  <div class="card"><div style="height:360px"><canvas id="chart-pp"></canvas></div></div>
  <div class="card"><div style="height:360px"><canvas id="chart-sh"></canvas></div></div>

  <div class="card">
    <small>Raw data (debug)</small>
    <pre id="raw"></pre>
  </div>
</div>
</body>
</html>
