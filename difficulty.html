<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Veil Mining Difficulty</title>

<style>
:root{
  --bg:#0b0f17; --card:#0f172a; --border:#1f2a44;
  --text:#e2e8f0; --muted:#94a3b8; --accent:#38bdf8;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:var(--bg);
  color:var(--text);
  overflow-y:scroll;   /* prevents scrollbar flicker -> resize loop */
  overflow-x:hidden;
}
.wrap{max-width:1100px;margin:auto;padding:24px}
header{
  border:1px solid var(--border);
  border-radius:16px;
  background:var(--card);
  padding:16px;
}
h1{margin:0 0 6px;font-size:22px}
.sub{margin:0;color:var(--muted)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
.btn{
  border:1px solid var(--border);
  background:#020617;
  color:var(--text);
  padding:9px 12px;
  border-radius:12px;
  cursor:pointer;
  text-decoration:none;
}
.grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
.card{
  border:1px solid var(--border);
  border-radius:16px;
  background:var(--card);
  padding:16px;
  overflow:hidden;
}
.card h3{margin:0 0 10px}
.small{color:var(--muted);font-size:12px;margin-top:8px}
.canvasWrap{
  width:100%;
  height:320px;
  background:#020617;
  border:1px solid rgba(255,255,255,.06);
  border-radius:12px;
  overflow:hidden;
}
canvas{
  display:block;
  width:100%;
  height:100%;
}
pre{
  margin:0;
  white-space:pre-wrap;
  background:#020617;
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
  overflow:auto;
  max-height:260px;
  color:#cbd5e1;
}
code{color:#cbd5e1}
footer{margin-top:16px;text-align:center;color:var(--muted);font-size:12px}
</style>
</head>

<body>
<div class="wrap">

<header>
  <h1>Veil Mining Difficulty</h1>
  <!-- <p class="sub">Loads <code>./data/difficulty.json</code> and plots difficulty history per algo.</p> -->
  <div class="row">
    <button class="btn" id="refresh">Refresh</button>
    <a class="btn" href="./index.html">Back</a>
    <a class="btn" href="./data/difficulty.json" target="_blank" rel="noopener">View JSON</a>
  </div>
</header>

<div class="grid">
  <div class="card">
    <h3>RandomX</h3>
    <div class="canvasWrap"><canvas id="rx"></canvas></div>
    <div class="small" id="rxNote"></div>
  </div>

  <div class="card">
    <h3>ProgPoW</h3>
    <div class="canvasWrap"><canvas id="pp"></canvas></div>
    <div class="small" id="ppNote"></div>
  </div>

  <div class="card">
    <h3>SHA256d</h3>
    <div class="canvasWrap"><canvas id="sha"></canvas></div>
    <div class="small" id="shaNote"></div>
  </div>

  <!-- <div class="card">
     <h3>Debug</h3> 
    <pre id="debug">Waiting…</pre>
  </div>
</div> -->

<footer>Veil Mining Hub • community-run</footer>

</div>

<script>
const DATA_URL = "./data/difficulty.json";
const dbgEl = document.getElementById("debug");

function dbg(msg){ dbgEl.textContent = msg; }

function nice(n){
  if (!Number.isFinite(n)) return "n/a";
  const a = Math.abs(n);
  if (a >= 1e12) return (n/1e12).toFixed(2) + "T";
  if (a >= 1e9)  return (n/1e9).toFixed(2) + "B";
  if (a >= 1e6)  return (n/1e6).toFixed(2) + "M";
  if (a >= 1e3)  return (n/1e3).toFixed(2) + "K";
  if (a !== 0 && a < 0.01) return n.toExponential(4);
  return String(+n.toFixed(8));
}

// Make canvas pixel-perfect without triggering layout growth.
function fitCanvasToCSS(canvas){
  const wrap = canvas.parentElement; // .canvasWrap
  const rect = wrap.getBoundingClientRect();
  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1)); // cap DPR to avoid huge memory
  const w = Math.floor(rect.width * dpr);
  const h = Math.floor(rect.height * dpr);
  if (canvas.width !== w || canvas.height !== h) {
    canvas.width = w;
    canvas.height = h;
  }
  return { w, h, dpr };
}

function fmtDate(iso){
  if (!iso) return "";
  const dt = new Date(iso);
  if (Number.isNaN(dt.getTime())) return String(iso);
  // Example: "12-16 14:23" (UTC)
  const MM = String(dt.getUTCMonth() + 1).padStart(2, "0");
  const DD = String(dt.getUTCDate()).padStart(2, "0");
  const hh = String(dt.getUTCHours()).padStart(2, "0");
  const mm = String(dt.getUTCMinutes()).padStart(2, "0");
  return `${MM}-${DD} ${hh}:${mm}`;
}

// Convert your JSON arrays into [{t,d}, ...], sorted, numeric-only.
function toPoints(arr){
  if (!Array.isArray(arr)) return [];
  const pts = arr
    .map(p => ({ t: p?.t ?? null, d: Number(p?.d) }))
    .filter(p => Number.isFinite(p.d));
  pts.sort((a,b) => String(a.t).localeCompare(String(b.t)));
  return pts;
}

function drawLineChart(canvasId, points, title){
  const canvas = document.getElementById(canvasId);
  const { w, h } = fitCanvasToCSS(canvas);
  const ctx = canvas.getContext("2d");

  // Background ALWAYS
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle = "#020617";
  ctx.fillRect(0,0,w,h);

  if (!Array.isArray(points) || points.length === 0) {
    ctx.fillStyle = "#94a3b8";
    ctx.font = "14px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillText("No data points yet.", 16, 32);
    return;
  }

  const ys = points.map(p => Number(p.d)).filter(Number.isFinite);
  if (!ys.length) {
    ctx.fillStyle = "#fbbf24";
    ctx.font = "14px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillText("No numeric difficulty values found.", 16, 32);
    return;
  }

  // Chart padding
  const padL = 60, padR = 16, padT = 16, padB = 46;
  const cw = Math.max(10, w - padL - padR);
  const ch = Math.max(10, h - padT - padB);

  let min = Math.min(...ys);
  let max = Math.max(...ys);
  if (min === max) { min *= 0.9; max *= 1.1; }

  const n = points.length;
  const xAt = (i) => padL + cw * (n === 1 ? 0 : i / (n - 1));
  const yAt = (v) => {
    const t = (v - min) / (max - min);
    return padT + ch * (1 - t);
  };

  // Font (needed for measureText)
  ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";

  // Horizontal reference lines + Y labels
  const gridY = 4;
  ctx.strokeStyle = "rgba(255,255,255,.07)";
  ctx.lineWidth = 1;
  ctx.fillStyle = "#94a3b8";

  for (let i=0;i<=gridY;i++){
    const y = padT + (ch * i / gridY);

    ctx.beginPath();
    ctx.moveTo(padL, y);
    ctx.lineTo(padL + cw, y);
    ctx.stroke();

    const v = max - (max - min) * (i / gridY);
    ctx.fillText(nice(v), 8, y + 4);
  }

  // Vertical reference lines + X labels (dates)
  const gridX = 4;
  for (let i=0;i<=gridX;i++){
    const idx = Math.round((n - 1) * (i / gridX));
    const x = xAt(idx);

    // vertical line
    ctx.beginPath();
    ctx.moveTo(x, padT);
    ctx.lineTo(x, padT + ch);
    ctx.stroke();

    // tick
    ctx.strokeStyle = "rgba(255,255,255,.12)";
    ctx.beginPath();
    ctx.moveTo(x, padT + ch);
    ctx.lineTo(x, padT + ch + 6);
    ctx.stroke();
    ctx.strokeStyle = "rgba(255,255,255,.07)";

    // label
    const label = fmtDate(points[idx]?.t);
    const tw = ctx.measureText(label).width;
    const lx = Math.min(Math.max(x - tw/2, padL), padL + cw - tw);
    ctx.fillText(label, lx, padT + ch + 22);
  }

  // Line (robust start)
  ctx.strokeStyle = "#38bdf8";
  ctx.lineWidth = 2;
  let started = false;

  ctx.beginPath();
  for (let i=0;i<n;i++){
    const v = Number(points[i]?.d);
    if (!Number.isFinite(v)) continue;
    const x = xAt(i);
    const y = yAt(v);
    if (!started) { ctx.moveTo(x, y); started = true; }
    else ctx.lineTo(x, y);
  }
  if (started) ctx.stroke();

  // Title / last value
  const last = ys[ys.length - 1];
  ctx.fillStyle = "#e2e8f0";
  ctx.font = "13px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  // ctx.fillText(`${title} • last: ${nice(last)} • points: ${ys.length}`, padL, h - 10);
}

async function load(){
  //dbg(`Loading ${DATA_URL} …`);

  let data;
  try {
    const res = await fetch(DATA_URL, { cache: "no-store" });
    if (!res.ok) throw new Error(`fetch failed: ${res.status} ${res.statusText}`);

    // Safer: detect accidental HTML / 404
    const text = await res.text();
    try { data = JSON.parse(text); }
    catch { throw new Error(`Not valid JSON. First 120 chars:\n${text.slice(0,120)}`); }
  } catch (e) {
    dbg(`ERROR loading JSON:\n${e && e.stack ? e.stack : e}`);
    return;
  }

  const rxPts  = toPoints(data.randomx);
  const ppPts  = toPoints(data.progpow);
  const shaPts = toPoints(data.sha256d);

  drawLineChart("rx",  rxPts,  "RandomX");
  drawLineChart("pp",  ppPts,  "ProgPoW");
  drawLineChart("sha", shaPts, "SHA256d");

  /* document.getElementById("rxNote").textContent  =
    `points: ${rxPts.length}${rxPts.length ? " • last: " + nice(rxPts[rxPts.length-1].d) : ""}`;
  document.getElementById("ppNote").textContent  =
    `points: ${ppPts.length}${ppPts.length ? " • last: " + nice(ppPts[ppPts.length-1].d) : ""}`;
  document.getElementById("shaNote").textContent =
    `points: ${shaPts.length}${shaPts.length ? " • last: " + nice(shaPts[shaPts.length-1].d) : ""}`;

  dbg(
    `OK\n` +
    `updated: ${data.updated ?? "(none)"}\n` +
    `source:  ${data.source ?? "(none)"}\n` +
    `keys:    ${Object.keys(data).join(", ")}\n\n` +
    `randomx:  ${rxPts.length} points\n` +
    `progpow:  ${ppPts.length} points\n` +
    `sha256d:  ${shaPts.length} points\n`
  );*/
}

document.getElementById("refresh").addEventListener("click", load);

// Redraw once on resize (no loops), debounced
let resizeTimer = null;
window.addEventListener("resize", () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(load, 200);
});

load();
</script>
</body>
</html>
