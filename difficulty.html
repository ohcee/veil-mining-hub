<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Veil Mining Difficulty</title>

<style>
:root{
  --bg:#0b0f17; --card:#0f172a; --border:#1f2a44;
  --text:#e2e8f0; --muted:#94a3b8; --accent:#38bdf8;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:var(--bg);
  color:var(--text);
  overflow-y:scroll;   /* IMPORTANT: prevents scrollbar flicker -> resize loop */
  overflow-x:hidden;
}
.wrap{max-width:1100px;margin:auto;padding:24px}
header{
  border:1px solid var(--border);
  border-radius:16px;
  background:var(--card);
  padding:16px;
}
h1{margin:0 0 6px;font-size:22px}
.sub{margin:0;color:var(--muted)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
.btn{
  border:1px solid var(--border);
  background:#020617;
  color:var(--text);
  padding:9px 12px;
  border-radius:12px;
  cursor:pointer;
  text-decoration:none;
}
.grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
.card{
  border:1px solid var(--border);
  border-radius:16px;
  background:var(--card);
  padding:16px;
  overflow:hidden; /* prevents any inner content from expanding the page */
}
.card h3{margin:0 0 10px}
.small{color:var(--muted);font-size:12px;margin-top:8px}
.canvasWrap{
  width:100%;
  height:320px;        /* fixed height, no growth */
  background:#020617;
  border:1px solid rgba(255,255,255,.06);
  border-radius:12px;
  overflow:hidden;     /* critical */
}
canvas{
  display:block;
  width:100%;
  height:100%;
}
pre{
  margin:0;
  white-space:pre-wrap;
  background:#020617;
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
  overflow:auto;
  max-height:260px;
  color:#cbd5e1;
}
code{color:#cbd5e1}
footer{margin-top:16px;text-align:center;color:var(--muted);font-size:12px}
</style>
</head>

<body>
<div class="wrap">

<header>
  <h1>Veil Mining Difficulty</h1>
  <p class="sub">Loads <code>./data/difficulty.json</code> and plots difficulty history per algo.</p>
  <div class="row">
    <button class="btn" id="refresh">Refresh</button>
    <a class="btn" href="./index.html">Back</a>
    <a class="btn" href="./data/difficulty.json" target="_blank" rel="noopener">View JSON</a>
  </div>
</header>

<div class="grid">
  <div class="card">
    <h3>RandomX</h3>
    <div class="canvasWrap"><canvas id="rx"></canvas></div>
    <div class="small" id="rxNote"></div>
  </div>

  <div class="card">
    <h3>ProgPoW</h3>
    <div class="canvasWrap"><canvas id="pp"></canvas></div>
    <div class="small" id="ppNote"></div>
  </div>

  <div class="card">
    <h3>SHA256d</h3>
    <div class="canvasWrap"><canvas id="sha"></canvas></div>
    <div class="small" id="shaNote"></div>
  </div>

  <div class="card">
    <h3>Debug</h3>
    <pre id="debug">Waiting…</pre>
  </div>
</div>

<footer>Veil Mining Hub • community-run</footer>

</div>

<script>
const DATA_URL = "./data/difficulty.json";
const dbgEl = document.getElementById("debug");

function dbg(msg){ dbgEl.textContent = msg; }

function nice(n){
  if (!Number.isFinite(n)) return "n/a";
  const a = Math.abs(n);
  if (a >= 1e12) return (n/1e12).toFixed(2) + "T";
  if (a >= 1e9)  return (n/1e9).toFixed(2) + "B";
  if (a >= 1e6)  return (n/1e6).toFixed(2) + "M";
  if (a >= 1e3)  return (n/1e3).toFixed(2) + "K";
  if (a !== 0 && a < 0.01) return n.toExponential(4);
  return String(+n.toFixed(8));
}

// Make canvas pixel-perfect without triggering layout growth.
function fitCanvasToCSS(canvas){
  const wrap = canvas.parentElement; // .canvasWrap
  const rect = wrap.getBoundingClientRect();
  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1)); // cap DPR to avoid huge memory
  const w = Math.floor(rect.width * dpr);
  const h = Math.floor(rect.height * dpr);
  if (canvas.width !== w || canvas.height !== h) {
    canvas.width = w;
    canvas.height = h;
  }
  return { w, h, dpr };
}

function drawLineChart(canvasId, series, title){
  const canvas = document.getElementById(canvasId);
  const { w, h } = fitCanvasToCSS(canvas);
  const ctx = canvas.getContext("2d");

  // Clear
  ctx.clearRect(0,0,w,h);

  // Background
  ctx.fillStyle = "#020617";
  ctx.fillRect(0,0,w,h);

  // If no data, show message
  if (!series.length) {
    ctx.fillStyle = "#94a3b8";
    ctx.font = `${Math.max(12, Math.floor(h*0.05))}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
    ctx.fillText("No data points yet.", 16, 32);
    return;
  }

  // Chart padding
  const padL = 44, padR = 16, padT = 16, padB = 34;
  const cw = Math.max(10, w - padL - padR);
  const ch = Math.max(10, h - padT - padB);

  // Compute min/max
  let min = Infinity, max = -Infinity;
  for (const v of series) { if (v < min) min = v; if (v > max) max = v; }
  if (!Number.isFinite(min) || !Number.isFinite(max)) {
    ctx.fillStyle = "#fbbf24";
    ctx.font = "14px system-ui";
    ctx.fillText("Data contains non-numeric values.", 16, 32);
    return;
  }
  if (min === max) { min *= 0.9; max *= 1.1; } // avoid flatline divide-by-zero

  // Grid
  ctx.strokeStyle = "rgba(255,255,255,.06)";
  ctx.lineWidth = 1;

  const gridY = 4;
  for (let i=0;i<=gridY;i++){
    const y = padT + (ch * i / gridY);
    ctx.beginPath();
    ctx.moveTo(padL, y);
    ctx.lineTo(padL + cw, y);
    ctx.stroke();
  }

  // Axes labels (simple)
  ctx.fillStyle = "#94a3b8";
  ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText(nice(max), 8, padT + 10);
  ctx.fillText(nice(min), 8, padT + ch);

  // Line
  ctx.strokeStyle = "#38bdf8";
  ctx.lineWidth = 2;

  const n = series.length;
  ctx.beginPath();
  for (let i=0;i<n;i++){
    const x = padL + (cw * (n === 1 ? 0 : i / (n - 1)));
    const t = (series[i] - min) / (max - min);
    const y = padT + (ch * (1 - t));
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.stroke();

  // Title / last value
  ctx.fillStyle = "#e2e8f0";
  ctx.font = "13px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  const last = series[series.length - 1];
  ctx.fillText(`${title} • last: ${nice(last)} • points: ${series.length}`, padL, h - 12);
}

async function load(){
  dbg(`Loading ${DATA_URL} …`);

  let data;
  try {
    const res = await fetch(DATA_URL, { cache: "no-store" });
    if (!res.ok) throw new Error(`fetch failed: ${res.status} ${res.statusText}`);
    data = await res.json();
  } catch (e) {
    dbg(`ERROR loading JSON:\n${e && e.stack ? e.stack : e}`);
    return;
  }

  // Expected keys: randomx, progpow, sha256d
  const rx  = Array.isArray(data.randomx) ? data.randomx.map(Number).filter(Number.isFinite) : [];
  const pp  = Array.isArray(data.progpow) ? data.progpow.map(Number).filter(Number.isFinite) : [];
  const sha = Array.isArray(data.sha256d) ? data.sha256d.map(Number).filter(Number.isFinite) : [];

  drawLineChart("rx",  rx,  "RandomX");
  drawLineChart("pp",  pp,  "ProgPoW");
  drawLineChart("sha", sha, "SHA256d");

  document.getElementById("rxNote").textContent  = `points: ${rx.length}${rx.length ? " • last: " + nice(rx[rx.length-1]) : ""}`;
  document.getElementById("ppNote").textContent  = `points: ${pp.length}${pp.length ? " • last: " + nice(pp[pp.length-1]) : ""}`;
  document.getElementById("shaNote").textContent = `points: ${sha.length}${sha.length ? " • last: " + nice(sha[sha.length-1]) : ""}`;

  dbg(
    `OK\n` +
    `updated: ${data.updated ?? "(none)"}\n` +
    `source:  ${data.source ?? "(none)"}\n` +
    `keys:    ${Object.keys(data).join(", ")}\n\n` +
    `randomx:  ${rx.length} points\n` +
    `progpow:  ${pp.length} points\n` +
    `sha256d:  ${sha.length} points\n`
  );
}

document.getElementById("refresh").addEventListener("click", load);

// Redraw once on resize (no loops), debounced
let resizeTimer = null;
window.addEventListener("resize", () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(load, 200);
});

load();
</script>
</body>
</html>
